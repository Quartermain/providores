var Autocompleter=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:true,width:"inherit",maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:true,className:"autocompleter-choices",zIndex:42,delay:400,observerOptions:{},fxOptions:{},autoSubmit:false,overflow:false,overflowMargin:25,selectFirst:false,filter:null,filterCase:false,filterSubset:false,forceSelect:false,selectMode:true,choicesMatch:null,multiple:false,separator:", ",separatorSplit:/\s*[,;]\s*/,autoTrim:false,allowDupes:false,cache:true,relative:false},initialize:function(e,t){this.element=$(e);this.setOptions(t);this.build();this.observer=new Observer(this.element,this.prefetch.bind(this),Object.merge({delay:this.options.delay},this.options.observerOptions));this.queryValue=null;if(this.options.filter)this.filter=this.options.filter.bind(this);var n=this.options.selectMode;this.typeAhead=n=="type-ahead";this.selectMode=n===true?"selection":n;this.cached=[]},build:function(){if($(this.options.customChoices)){this.choices=this.options.customChoices}else{this.choices=(new Element("ul",{"class":this.options.className,styles:{zIndex:this.options.zIndex}})).inject(document.body);this.relative=false;if(this.options.relative){this.choices.inject(this.element,"after");this.relative=this.element.getOffsetParent()}this.fix=new OverlayFix(this.choices)}if(!this.options.separator.test(this.options.separatorSplit)){this.options.separatorSplit=this.options.separator}this.fx=!this.options.fxOptions?null:(new Fx.Tween(this.choices,Object.merge({property:"opacity",link:"cancel",duration:200},this.options.fxOptions))).addEvent("onStart",Chain.prototype.clearChain).set(0);this.element.setProperty("autocomplete","off").addEvent(Browser.ie||Browser.safari||Browser.chrome?"keydown":"keypress",this.onCommand.bind(this)).addEvent("click",this.onCommand.bind(this,false)).addEvent("focus",this.toggleFocus.bind(this,true)).addEvent("blur",this.toggleFocus.bind(this,false))},destroy:function(){if(this.fix)this.fix.destroy();this.choices=this.selected=this.choices.destroy()},toggleFocus:function(e){this.focussed=e;if(!e)this.hideChoices(true);this.fireEvent(e?"onFocus":"onBlur",[this.element])},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift){switch(e.key){case"enter":if(this.element.value!=this.opted)return true;if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!this.options.autoSubmit}break;case"up":case"down":if(!this.prefetch()&&this.queryValue!==null){var t=e.key=="up";this.choiceOver((this.selected||this.choices)[this.selected?t?"getPrevious":"getNext":t?"getLast":"getFirst"](this.options.choicesMatch),true)}return false;case"esc":case"tab":this.hideChoices(true);break}}return true},setSelection:function(e){var t=this.selected.inputValue,n=t;var r=this.queryValue.length,i=t.length;if(t.substr(0,r).toLowerCase()!=this.queryValue.toLowerCase())r=0;if(this.options.multiple){var s=this.options.separatorSplit;n=this.element.value;r+=this.queryIndex;i+=this.queryIndex;var o=n.substr(this.queryIndex).split(s,1)[0];n=n.substr(0,this.queryIndex)+t+n.substr(this.queryIndex+o.length);if(e){var u=n.split(this.options.separatorSplit).filter(function(e){return this.test(e)},/[^\s,]+/);if(!this.options.allowDupes)u=[].combine(u);var a=this.options.separator;n=u.join(a)+a;i=n.length}}this.observer.setValue(n);this.opted=n;if(e||this.selectMode=="pick")r=i;this.element.selectRange(r,i);this.fireEvent("onSelection",[this.element,this.selected,n,t])},showChoices:function(){var e=this.options.choicesMatch,t=this.choices.getFirst(e);this.selected=this.selectedValue=null;if(this.fix){var n=this.element.getCoordinates(this.relative),r=this.options.width||"auto";this.choices.setStyles({left:n.left,top:n.bottom,width:r===true||r=="inherit"?n.width:r})}if(!t)return;if(!this.visible){this.visible=true;this.choices.setStyle("display","");if(this.fx)this.fx.start(1);this.fireEvent("onShow",[this.element,this.choices])}if(this.options.selectFirst||this.typeAhead||t.inputValue==this.queryValue)this.choiceOver(t,this.typeAhead);var i=this.choices.getChildren(e),s=this.options.maxChoices;var o={overflowY:"hidden",height:""};this.overflown=false;if(i.length>s){var u=i[s-1];o.overflowY="scroll";o.height=u.getCoordinates(this.choices).bottom;this.overflown=true}this.choices.setStyles(o);this.fix.show();if(this.options.visibleChoices){var a=document.getScroll(),f=document.getSize(),l=this.choices.getCoordinates();if(l.right>a.x+f.x)a.x=l.right-f.x;if(l.bottom>a.y+f.y)a.y=l.bottom-f.y;window.scrollTo(Math.min(a.x,l.left),Math.min(a.y,l.top))}},hideChoices:function(e){if(e){var t=this.element.value;if(this.options.forceSelect)t=this.opted;if(this.options.autoTrim){t=t.split(this.options.separatorSplit).filter(arguments[0]).join(this.options.separator)}this.observer.setValue(t)}if(!this.visible)return;this.visible=false;if(this.selected)this.selected.removeClass("autocompleter-selected");this.observer.clear();var n=function(){this.choices.setStyle("display","none");this.fix.hide()}.bind(this);if(this.fx)this.fx.start(0).chain(n);else n();this.fireEvent("onHide",[this.element,this.choices])},prefetch:function(){var e=this.element.value,t=e;if(this.options.multiple){var n=this.options.separatorSplit;var r=e.split(n);var i=this.element.getSelectedRange().start;var s=e.substr(0,i).split(n);var o=s.length-1;i-=s[o].length;t=r[o]}if(t.length<this.options.minLength){this.hideChoices()}else{if(t===this.queryValue||this.visible&&t==this.selectedValue){if(this.visible)return false;this.showChoices()}else{this.queryValue=t;this.queryIndex=i;if(!this.fetchCached())this.query()}}return true},fetchCached:function(){return false;if(!this.options.cache||!this.cached||!this.cached.length||this.cached.length>=this.options.maxChoices||this.queryValue)return false;this.update(this.filter(this.cached));return true},update:function(e){this.choices.empty();this.cached=e;var t=e&&typeOf(e);if(!t||t=="array"&&!e.length||t=="hash"&&!e.getLength()){(this.options.emptyChoices||this.hideChoices).call(this)}else{if(this.options.maxChoices<e.length&&!this.options.overflow)e.length=this.options.maxChoices;e.each(this.options.injectChoice||function(e){var t=new Element("li",{html:this.markQueryValue(e)});t.inputValue=e;this.addChoiceEvents(t).inject(this.choices)},this);this.showChoices()}},choiceOver:function(e,t){if(!e||e==this.selected)return;if(this.selected)this.selected.removeClass("autocompleter-selected");this.selected=e.addClass("autocompleter-selected");this.fireEvent("onSelect",[this.element,this.selected,t]);if(!this.selectMode)this.opted=this.element.value;if(!t)return;this.selectedValue=this.selected.inputValue;if(this.overflown){var n=this.selected.getCoordinates(this.choices),r=this.options.overflowMargin,i=this.choices.scrollTop,s=this.choices.offsetHeight,o=i+s;if(n.top-r<i&&i)this.choices.scrollTop=Math.max(n.top-r,0);else if(n.bottom+r>o)this.choices.scrollTop=Math.min(n.bottom-s+r,o)}if(this.selectMode)this.setSelection()},choiceSelect:function(e){if(e)this.choiceOver(e);this.setSelection(true);this.queryValue=false;this.hideChoices()},filter:function(e){return(e||this.tokens).filter(function(e){return this.test(e)},new RegExp((this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp(),this.options.filterCase?"":"i"))},markQueryValue:function(e){if(!e)return;return!this.options.markQuery||!this.queryValue?e:e.replace(new RegExp("("+(this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp()+")",this.options.filterCase?"":"i"),'<span class="autocompleter-queried">$1</span>')},addChoiceEvents:function(e){return e.addEvents({mouseover:this.choiceOver.bind(this,e),click:this.choiceSelect.bind(this,e)})}});var OverlayFix=new Class({initialize:function(e){if(Browser.ie){this.element=$(e);this.relative=this.element.getOffsetParent();this.fix=(new Element("iframe",{frameborder:"0",scrolling:"no",src:"javascript:false;",styles:{position:"absolute",border:"none",display:"none",filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"}})).inject(this.element,"after")}},show:function(){if(this.fix){var e=this.element.getCoordinates(this.relative);delete e.right;delete e.bottom;this.fix.setStyles(Object.append(e,{display:"",zIndex:(this.element.getStyle("zIndex")||1)-1}))}return this},hide:function(){if(this.fix)this.fix.setStyle("display","none");return this},destroy:function(){if(this.fix)this.fix=this.fix.destroy()}});Element.implement({getSelectedRange:function(){if(!Browser.ie)return{start:this.selectionStart,end:this.selectionEnd};var e={start:0,end:0};var t=this.getDocument().selection.createRange();if(!t||t.parentElement()!=this)return e;var n=t.duplicate();if(this.type=="text"){e.start=0-n.moveStart("character",-1e5);e.end=e.start+t.text.length}else{var r=this.value;var i=r.length-r.match(/[\n\r]*$/)[0].length;n.moveToElementText(this);n.setEndPoint("StartToEnd",t);e.end=i-n.text.length;n.setEndPoint("StartToStart",t);e.start=i-n.text.length}return e},selectRange:function(e,t){if(Browser.ie){var n=this.value.substr(e,t-e).replace(/\r/g,"").length;e=this.value.substr(0,e).replace(/\r/g,"").length;var r=this.createTextRange();r.collapse(true);r.moveEnd("character",e+n);r.moveStart("character",e);r.select()}else{this.focus();this.setSelectionRange(e,t)}return this}});Autocompleter.Base=Autocompleter

var Observer=new Class({Implements:[Options,Events],options:{periodical:false,delay:1e3},initialize:function(e,t,n){this.element=$(e)||$$(e);this.addEvent("onFired",t);this.setOptions(n);this.bound=this.changed.bind(this);this.resume()},changed:function(){var e=this.element.get("value");if($equals(this.value,e))return;this.clear();this.value=e;this.timeout=this.onFired.delay(this.options.delay,this)},setValue:function(e){this.value=e;this.element.set("value",e);return this.clear()},onFired:function(){this.fireEvent("onFired",[this.value,this.element])},clear:function(){clearTimeout(this.timeout||null);return this},pause:function(){if(this.timer)clearInterval(this.timer);else this.element.removeEvent("keyup",this.bound);return this.clear()},resume:function(){this.value=this.element.get("value");if(this.options.periodical)this.timer=this.changed.periodical(this.options.periodical,this);else this.element.addEvent("keyup",this.bound);return this}});var $equals=function(e,t){return e==t||JSON.encode(e)==JSON.encode(t)}

Autocompleter.Local=new Class({Extends:Autocompleter,options:{minLength:0,delay:200},initialize:function(e,t,n){this.parent(e,n);this.tokens=t},query:function(){this.update(this.filter())}})

Autocompleter.Request=new Class({Extends:Autocompleter,options:{postData:{},ajaxOptions:{},postVar:"value"},query:function(){var e=Object.clone(this.options.postData)||{};e[this.options.postVar]=this.queryValue;var t=$(this.options.indicator);if(t)t.setStyle("display","");var n=this.options.indicatorClass;if(n)this.element.addClass(n);this.fireEvent("onRequest",[this.element,this.request,e,this.queryValue]);this.request.send({data:e})},queryResponse:function(){var e=$(this.options.indicator);if(e)e.setStyle("display","none");var t=this.options.indicatorClass;if(t)this.element.removeClass(t);return this.fireEvent("onComplete",[this.element,this.request])}});Autocompleter.Request.JSON=new Class({Extends:Autocompleter.Request,initialize:function(e,t,n){this.parent(e,n);this.request=(new Request.JSON(Object.merge({url:t,link:"cancel"},this.options.ajaxOptions))).addEvent("onComplete",this.queryResponse.bind(this))},queryResponse:function(e){this.parent();this.update(e)}});Autocompleter.Request.HTML=new Class({Extends:Autocompleter.Request,initialize:function(e,t,n){this.parent(e,n);this.request=(new Request.HTML(Object.merge({url:t,link:"cancel",update:this.choices},this.options.ajaxOptions))).addEvent("onComplete",this.queryResponse.bind(this))},queryResponse:function(e,t){this.parent();if(!t||!t.length){this.hideChoices()}else{this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(e){var t=e.innerHTML;e.inputValue=t;this.addChoiceEvents(e.set("html",this.markQueryValue(t)))},this);this.showChoices()}}});Autocompleter.Ajax={Base:Autocompleter.Request,Json:Autocompleter.Request.JSON,Xhtml:Autocompleter.Request.HTML}


